<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Garage - Santaverse</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <header>
        <a href="index.html" class="header-brand" style="text-decoration: none; color: inherit;">
            <img src="img/logo_nitro_reindeer.png" alt="Santaverse Logo">
            <h1>Santaverse Garage</h1>
        </a>
        <nav>
            <a href="index.html">Marketplace</a>
            <a href="garage.html" class="active">My Garage</a>
        </nav>
    </header>

    <main>
        <div class="category-filter">
            <h2>Your Fleet</h2>
            <p>Customize and maintain Santa's rides.</p>
        </div>

        <div id="garage-grid" class="grid">
            <p>Loading Garage...</p>
        </div>
    </main>

    <script src="js/mock-data.js"></script>
    <script src="js/api-client.js"></script>
    <script src="js/app.js"></script>
    <script>
        let availableMods = [];

        document.addEventListener('DOMContentLoaded', async () => {
            const grid = document.getElementById('garage-grid');

            // Fetch mods first so we can populate dropdowns
            try {
                availableMods = await fetchMods();
            } catch (e) {
                console.warn("Could not fetch mods", e);
            }

            try {
                const vehicles = await fetchGarage();

                if (!vehicles || vehicles.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem;"><h3 style="color:var(--text-dim)">Your garage is looking a bit empty!</h3><p>Visit the <a href="index.html" style="color: var(--accent-gold);">Marketplace</a> to build your fleet.</p></div>';
                    return;
                }

                grid.innerHTML = vehicles.map(v => {
                    // Logic to swap image if mods are applied
                    let displayImage = v.item_image_url;
                    if (v.has_mods) {
                        const parts = v.item_image_url.split('.');
                        const ext = parts.pop();
                        const base = parts.join('.');
                        displayImage = `${base}_turbo.${ext}`;
                    }

                    // Generate Mod Dropdown Options
                    const modOptions = availableMods.map(m =>
                        `<option value="${m.id}">${m.name} (+${m.price}ðŸª™)</option>`
                    ).join('');

                    return `
                    <div class="card">
                        <img src="${displayImage}" alt="${v.item_name}" style="height: 180px;">
                        <div class="card-content">
                            <span class="card-category">${v.item_category} ${v.item_type}</span>
                            <h3 class="card-title">${v.item_name}</h3>
                            <p style="font-size: 0.9rem; color: #666">ID: ${v.id}</p>
                            ${formatStats(v.current_stats)}
                            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 1rem 0;">
                            
                            <div style="margin-bottom: 1rem;">
                                <label style="font-size: 0.8rem; color: var(--text-dim);">Install Mod:</label>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.2rem;">
                                    <select id="mod-select-${v.id}" style="flex: 1; padding: 0.5rem; border-radius: 5px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); color: var(--text-light);">
                                        <option value="">Select Upgrade...</option>
                                        ${modOptions}
                                    </select>
                                    <button onclick="handleApplyMod(${v.id})" class="btn" style="padding: 0.5rem 1rem;">Apply</button>
                                </div>
                            </div>

                            <div style="display: flex; gap: 0.5rem;">
                                ${v.has_mods ? `<button onclick="handleReset(${v.id})" class="btn" style="flex: 1; background: #eab308; color: black; box-shadow:none;">Reset</button>` : ''}
                                <button onclick="handleSell(${v.id})" class="btn btn-danger" style="flex: 1; padding: 0.5rem;">Sell</button>
                            </div>
                        </div>
                    </div>
                `}).join('');
            } catch (err) {
                grid.innerHTML = `<p style="color:red">Error loading garage: ${err.message}</p>`;
            }
        });

        async function handleApplyMod(vehicleId) {
            const select = document.getElementById(`mod-select-${vehicleId}`);
            const modId = parseInt(select.value);

            if (!modId) {
                alert("Please select a mod first!");
                return;
            }

            // Find mod details for confirmation
            const mod = availableMods.find(m => m.id === modId);
            if (confirm(`Install ${mod.name} for ðŸª™${mod.price}?`)) {
                try {
                    const result = await api.applyMod(vehicleId, modId);
                    alert("Mod Installed! System Upgraded.");
                    window.location.reload();
                } catch (err) {
                    alert(`Installation Failed: ${err.message}`);
                }
            }
        }

        async function handleSell(vehicleId) {
            if (confirm("Are you sure you want to return this vehicle to Santa? This cannot be undone.")) {
                try {
                    const res = await api.sellVehicle(vehicleId);
                    alert("Vehicle returned.");
                    window.location.reload();
                } catch (err) {
                    alert(err.message);
                }
            }
        }

        async function handleReset(vehicleId) {
            if (confirm("Remove all mods and restore factory settings?")) {
                try {
                    const res = await api.resetVehicle(vehicleId);
                    alert("Vehicle reset to stock.");
                    window.location.reload();
                } catch (err) {
                    alert(err.message);
                }
            }
        }
    </script>
</body>

</html>